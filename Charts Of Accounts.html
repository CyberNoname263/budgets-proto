<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chart of Accounts ‚Äî Single Table</title>

    <!-- ============================
         Embedded CSS (Developer-friendly & commented)
         ============================ -->
    <style>
        :root{
            --bg: #f9fafb;
            --muted: #6b7280;
            --accent: #2eb67d;
            --accent-2: #12a05b;
            --radius: 12px;
            --shadow-soft: 0 6px 18px rgba(8,12,14,0.06);
            --header-height: 56px; /* used for sticky category offset */
            --table-header-bg: #f3f4f6; /* light gray header */
            font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            -webkit-font-smoothing:antialiased;
            color-scheme: light;
        }

        /* --- Page basics --- */
        html,body{height:100%;margin:0;background:var(--bg);color:#111}
        .wrap{max-width:1200px;margin:20px auto;padding:18px}

        header.top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
        .brand{display:flex;gap:12px;align-items:center}
        .logo{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;color:#fff;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 12px 30px rgba(46,182,125,0.18)}
        h1{margin:0;font-size:1.15rem}
        .sub{color:var(--muted);font-size:.92rem}

        /* --- Controls / quick-add cards --- */
        .top-panel{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:14px}
        .control-card{
            background: #fff;
            border-radius:var(--radius);
            padding:12px;
            border:1px solid #eef0f1;
            box-shadow:var(--shadow-soft);
            min-width:300px;
            flex:1;
        }
        .control-card h3{margin:0 0 8px 0;font-size:1rem}
        .controls-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        input[type="text"], select{padding:10px 12px;border-radius:10px;border:1px solid #e8eaec;background:transparent;color:inherit}
        input.full{flex:1;min-width:160px}

        /* --- Buttons style A (white minimal) --- */
        .btn{
            cursor:pointer;border-radius:10px;padding:9px 12px;font-weight:700;background:#fff;border:1px solid #e6e7e9;box-shadow:0 6px 16px rgba(8,12,14,0.04)
        }
        .btn:hover{transform:translateY(-1px);box-shadow:0 18px 36px rgba(8,12,14,0.08)}
        .btn.primary{ color: #0b6b3b; background:#ffffff; }
        .btn.ghost{background:transparent;border:1px solid #e6e7e9}

        .filter-row{display:flex;gap:8px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
        .search{display:flex;gap:8px;align-items:center;padding:10px 12px;border-radius:12px;background:#fff;border:1px solid #e9ebec;min-width:320px}
        .search input{border:0;background:transparent;outline:none}

        .main-card{background: #fff;border-radius:14px;padding:12px;border:1px solid #eef0f1;box-shadow:var(--shadow-soft)}

        /* =========================
           SINGLE TABLE STYLES
           ========================= */
        .single-table-wrap{
            overflow:auto;
            border-radius:10px;
            margin-top:8px;
            max-height:64vh; /* scroll area for table */
            border:1px solid #e6e7e8;
            background:#fff;
            position:relative;
        }

        table.coa {
            width:100%;
            border-collapse:collapse;
            min-width:900px;
            table-layout:fixed;
            font-size:0.95rem;
        }

        /* Sticky light-gray header */
        thead th {
            position: sticky;
            top: 0;
            z-index: 12;
            text-align:left;
            padding:12px;
            font-weight:700;
            background: var(--table-header-bg);
            color:#111827;
            border-bottom: 1px solid #e6e7e8;
            height: var(--header-height);
            vertical-align: middle;
        }
        thead th.action-th { text-align:right }

        /* Comfortable row density */
        tbody td{
            padding:12px;
            vertical-align:middle;
            border-bottom:1px solid #f1f2f3;
            background:transparent;
            word-wrap:break-word;
        }
        .code-pill{font-family:monospace;padding:6px 8px;border-radius:8px;background:rgba(0,0,0,0.03);font-weight:700;display:inline-block}

        /* Category merged row: spans all columns, no internal vertical borders.
           It is also sticky directly under the header (top offset is header height). */
        tr.category-row td{
            padding:12px 14px;
            background: #f7fbf8; /* default category bg */
            font-weight:800;
            color:var(--accent-2);
            text-transform:uppercase;
            letter-spacing:0.5px;
            border-top:1px solid #eef2f1;
            border-bottom:1px solid #eef2f1;
            position: sticky;
            top: calc(var(--header-height));
            z-index: 11; /* below header but above rows */
        }
        /* remove internal vertical border look */
        tr.category-row td { border-left: none; border-right: none; }

        /* When category becomes 'stuck' we slightly darken it (Option B).
           JS will add class .stuck to the active category row. */
        tr.category-row.stuck td {
            background: #e6f4ea; /* slightly darker/greener tint when pinned */
        }

        td.action-col{white-space:nowrap;text-align:right}
        tr.item-row:hover{background:linear-gradient(90deg, rgba(46,182,125,0.03), rgba(46,182,125,0.01)); transform:none}

        .footer-note{margin-top:12px;color:var(--muted);font-size:.92rem}

        /* Help button */
        .help-btn{
            position:fixed;right:22px;bottom:22px;width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:#fff;color:#0b6b3b;font-weight:800;border:1px solid #e6e7e8;box-shadow:0 8px 26px rgba(8,12,14,0.08);z-index:999;
        }
        .help-panel{
            position:fixed;right:20px;top:60px;width:420px;max-width:92%;height:calc(100vh - 120px);border-radius:14px;padding:12px;background:#fff;border:1px solid #e6e7e8;box-shadow:0 40px 60px rgba(8,12,14,0.12);transform:translateX(110%);transition:transform .28s;z-index:1000;display:flex;flex-direction:column;
        }
        .help-panel.open{transform:translateX(0)}
        .help-panel .header{display:flex;align-items:center;justify-content:space-between;padding-bottom:8px;border-bottom:1px solid #f1f2f3}
        .help-panel .content{overflow:auto;padding-top:10px;padding-right:6px}

        /* Print modal */
        .print-modal{ position: fixed; inset: 0; display:flex;align-items:center;justify-content:center; background: rgba(8,12,14,0.35); z-index:2000; visibility:hidden; opacity:0; transition:opacity .18s;}
        .print-modal.open{ visibility:visible; opacity:1; }
        .print-card{ width:420px; background:#fff; border-radius:12px; padding:16px; border:1px solid #e6e7e8; box-shadow:0 30px 60px rgba(8,12,14,0.12); }
        .company-input{width:100%;margin-top:10px;padding:8px;border-radius:8px;border:1px solid #e6e7e8}

        /* hide UI items when printing (we will print only the table from new window, but this helps for 'Print As-Is') */
        @media print {
            .no-print, .help-btn, .help-panel, .print-modal { display:none !important; }
            .single-table-wrap { border:none; box-shadow:none; }
            thead th { position: static !important } /* avoid sticky quirks when printing from same window */
        }
    </style>
</head>
<body>
<div class="wrap">
    <!-- Header -->
    <header class="top">
        <div class="brand">
            <div class="logo">COA</div>
            <div>
                <h1>Chart of Accounts</h1>
                <div class="sub">Organized by Category ‚Äî Revenue & Expenditure quick-add panels</div>
            </div>
        </div>

        <div class="top-actions no-print" style="display:flex; gap:8px;">
            <button class="btn ghost" onclick="window.location.href='Dashboard.html'">üè† Home</button>
            <button id="printBtn" class="btn primary">üñ®Ô∏è Print</button>
        </div>
    </header>

    <!-- Quick-add panels -->
    <div class="top-panel">
        <div class="control-card" aria-label="Revenue quick add">
            <h3>Revenue Class</h3>
            <div class="controls-row" style="margin-bottom:8px">
                <input id="revAccount" class="full" type="text" placeholder="Account name (Description)" />
            </div>
            <div class="controls-row" style="margin-bottom:8px">
                <input id="revCode" class="short" type="text" placeholder="Code (e.g. P1SP4-...)" />
                <label style="min-width:66px;color:var(--muted)">Category</label>
                <select id="revCategory" class="short"></select>
            </div>
            <div class="controls-row">
                <input id="revGroup" class="short" type="text" placeholder="Group (optional)" />
                <input id="revItem" class="short" type="text" placeholder="Item (optional)" />
                <button id="addRevenueBtn" class="btn primary" style="margin-left:auto">Add Revenue</button>
            </div>
        </div>

        <div class="control-card" aria-label="Expenditure quick add">
            <h3>Expenditure Class</h3>
            <div class="controls-row" style="margin-bottom:8px">
                <input id="expAccount" class="full" type="text" placeholder="Account name (Description)" />
            </div>
            <div class="controls-row" style="margin-bottom:8px">
                <input id="expCode" class="short" type="text" placeholder="Code (e.g. P1SP4-...)" />
                <label style="min-width:66px;color:var(--muted)">Category</label>
                <select id="expCategory" class="short"></select>
            </div>
            <div class="controls-row">
                <input id="expGroup" class="short" type="text" placeholder="Group (optional)" />
                <input id="expItem" class="short" type="text" placeholder="Item (optional)" />
                <button id="addExpenditureBtn" class="btn primary" style="margin-left:auto">Add Expenditure</button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-row">
        <div class="search" role="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <input id="searchInput" placeholder="Search Code / Description / Category / Group / Item" />
        </div>

        <select id="categoryFilter" class="filter"><option value="">All Categories</option></select>
        <button id="addCategoryBtn" class="btn ghost tiny">+ Add Category</button>

        <div style="margin-left:auto;display:flex;gap:8px" class="no-print">
            <label class="btn ghost tiny" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
                <input id="importCsv" type="file" accept=".csv" style="display:none" />
                Import CSV
            </label>
            <button id="exportCsvBtn" class="btn primary tiny">Export CSV</button>
        </div>
    </div>

    <!-- Main single-table -->
    <main class="main-card" aria-live="polite">
        <div id="groupsContainer"><!-- single table will be rendered here --></div>
        <div class="footer-note">Tip: Click <strong>Edit</strong> on any row to modify. All changes stored in your browser (localStorage).</div>
    </main>
</div>

<!-- Floating Help Button + Panel -->
<button id="helpBtn" class="help-btn no-print" aria-label="Open help">?</button>

<aside id="helpPanel" class="help-panel" role="dialog" aria-hidden="true" aria-labelledby="helpTitle">
    <div class="header">
        <h3 id="helpTitle">Help ‚Äî How to navigate</h3>
        <div>
            <button id="helpClose" class="close" title="Close help">‚úï</button>
        </div>
    </div>

    <div class="content" tabindex="0">
        <div class="quick-guide" role="region" aria-label="Quick guide">
            <h4>Quick navigation</h4>
            <p class="muted">Use the controls below to add, find, edit, export. Shortcuts are listed further down.</p>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
                <div style="padding:8px;border-radius:8px;background:#fff;border:1px solid #f1f2f3;font-weight:700">Add ‚Üí Fill fields, click <em>Add</em></div>
                <div style="padding:8px;border-radius:8px;background:#fff;border:1px solid #f1f2f3;font-weight:700">Search ‚Üí Type in search box</div>
                <div style="padding:8px;border-radius:8px;background:#fff;border:1px solid #f1f2f3;font-weight:700">Edit ‚Üí Click <em>Edit</em></div>
                <div style="padding:8px;border-radius:8px;background:#fff;border:1px solid #f1f2f3;font-weight:700">Export ‚Üí CSV</div>
            </div>
        </div>

        <div class="help-section">
            <h5>Main actions</h5>
            <div class="help-step">‚Ä¢ <strong>Add Revenue / Expenditure</strong> ‚Äî choose a Category (or create one), then Add. New account appears at top of that category.</div>
            <div class="help-step">‚Ä¢ <strong>Add Category</strong> ‚Äî click <em>+ Add Category</em> and enter a name. The category will appear in dropdowns and be added to the table (even if empty).</div>
            <div class="help-step">‚Ä¢ <strong>Edit / Delete</strong> ‚Äî use Edit to modify inline, Save or Cancel. Delete removes the row from your local dataset.</div>
        </div>

        <div class="help-section">
            <h5>Search & Filters</h5>
            <div class="help-step">‚Ä¢ Type keywords to filter Code, Description, Category, Group or Item.</div>
            <div class="help-step">‚Ä¢ Use the Category dropdown to view only items in a category.</div>
        </div>

        <div class="help-section">
            <h5>Import / Export</h5>
            <div class="help-step">‚Ä¢ Import CSV must contain columns: <code>Code,Description,Category,Group,Item,Class</code>.</div>
            <div class="help-step">‚Ä¢ Export CSV downloads the full dataset stored in your browser.</div>
        </div>

        <div class="help-section">
            <h5>Shortcuts</h5>
            <div class="help-step">‚Ä¢ <span class="kbd">Ctrl/Cmd + K</span> ‚Äî Open/Close Help<br>
                ‚Ä¢ <span class="kbd">Ctrl/Cmd + F</span> ‚Äî Focus internal search<br>
                ‚Ä¢ <span class="kbd">Alt + N</span> ‚Äî Focus Revenue account input</div>
        </div>
    </div>
</aside>

<!-- PRINT MODAL -->
<div id="printModal" class="print-modal" aria-hidden="true">
    <div class="print-card" role="dialog" aria-modal="true" aria-labelledby="printTitle">
        <button class="print-close" id="printClose" title="Close">‚úï</button>
        <h4 id="printTitle">Print options</h4>
        <div style="font-size:0.95rem;color:var(--muted);margin-top:6px">Choose how you want to print the table.</div>

        <label style="display:block;margin-top:12px;font-weight:700">Company name (optional)</label>
        <input id="printCompany" class="company-input" placeholder="Enter company name (optional)" />

        <div class="print-actions" style="margin-top:12px">
            <button id="btnPrintClean" class="btn">Print Clean</button>
            <button id="btnPrintProfessional" class="btn">Print Professional</button>
            <button id="btnPrintAsIs" class="btn">Print As-Is</button>
        </div>
    </div>
</div>

<!-- ============================
     Embedded JavaScript (commented & developer-friendly)
     ============================ -->
<script>
    /* -----------------------------------------
       Sample data + storage key
       ----------------------------------------- */
    const STORAGE_KEY = 'coa_hybrid_v1';
    const SAMPLE = [
        { code:'P1SP4-143000008', desc:'Trading Penalty', category:'Penalties & Fines', group:'Regulatory', item:'Trading', class:'Revenue' },
        { code:'P1SP4-143000013', desc:'Other penalties and fines', category:'Penalties & Fines', group:'Regulatory', item:'Other', class:'Revenue' },
        { code:'P1SP4-145200011', desc:'Interest on Deposits', category:'Finance Income', group:'Interest', item:'Deposits', class:'Revenue' },
        { code:'P1SP4-142100005', desc:'Proceeds from Disposal of Assets', category:'Other Income', group:'Disposal', item:'Assets', class:'Revenue' },
        { code:'P1SP4-21100001', desc:'Wages and salaries in cash', category:'Compensation of Employees', group:'Payroll', item:'SalariesCash', class:'Expenditure' },
        { code:'P1SP4-21100013', desc:'Wages and salaries in kind', category:'Compensation of Employees', group:'Payroll', item:'SalariesInKind', class:'Expenditure' },
        { code:'P1SP4-22001001', desc:'Telephone - mobile', category:'Communications', group:'Telecom', item:'Mobile', class:'Expenditure' }
    ];

    /* -----------------------------------------
       State
       ----------------------------------------- */
    let rows = loadRows() || SAMPLE.slice();
    let categories = new Set(rows.map(r => r.category).filter(Boolean));
    if(categories.size === 0) categories.add('Uncategorized');

    /* -----------------------------------------
       DOM Refs
       ----------------------------------------- */
    const groupsContainer = document.getElementById('groupsContainer');
    const revCategory = document.getElementById('revCategory');
    const expCategory = document.getElementById('expCategory');
    const categoryFilter = document.getElementById('categoryFilter');
    const searchInput = document.getElementById('searchInput');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const importCsv = document.getElementById('importCsv');
    const addRevenueBtn = document.getElementById('addRevenueBtn');
    const addExpenditureBtn = document.getElementById('addExpenditureBtn');

    const helpBtn = document.getElementById('helpBtn');
    const helpPanel = document.getElementById('helpPanel');
    const helpClose = document.getElementById('helpClose');

    const printBtn = document.getElementById('printBtn');
    const printModal = document.getElementById('printModal');
    const printClose = document.getElementById('printClose');
    const btnPrintClean = document.getElementById('btnPrintClean');
    const btnPrintProfessional = document.getElementById('btnPrintProfessional');
    const btnPrintAsIs = document.getElementById('btnPrintAsIs');
    const printCompany = document.getElementById('printCompany');

    /* -----------------------------------------
       Keyboard shortcuts
       ----------------------------------------- */
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
            e.preventDefault(); toggleHelp();
        }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
            e.preventDefault(); searchInput.focus(); searchInput.select();
        }
        if (e.altKey && e.key.toLowerCase() === 'n') {
            e.preventDefault(); document.getElementById('revAccount').focus();
        }
        if (e.key === 'Escape') {
            if (helpPanel.classList.contains('open')) closeHelp();
            if (printModal.classList.contains('open')) closePrintModal();
        }
    });

    helpBtn.addEventListener('click', toggleHelp);
    helpClose.addEventListener('click', closeHelp);

    function toggleHelp(){
        const open = helpPanel.classList.toggle('open');
        helpPanel.setAttribute('aria-hidden', !open);
        if(open) helpPanel.querySelector('.content')?.focus();
    }
    function closeHelp(){ helpPanel.classList.remove('open'); helpPanel.setAttribute('aria-hidden','true'); helpBtn.focus(); }

    /* -----------------------------------------
       Category controls refresh (dropdowns)
       ----------------------------------------- */
    function refreshCategoryControls(){
        const all = Array.from(new Set([...categories].sort((a,b)=> a.localeCompare(b))));
        [revCategory, expCategory, categoryFilter].forEach(sel=>{
            if(!sel) return;
            if(sel === categoryFilter){
                const defaultOpt = '<option value="">All Categories</option>';
                sel.innerHTML = defaultOpt + all.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
            } else {
                sel.innerHTML = all.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
            }
        });
    }
    refreshCategoryControls();

    /* -----------------------------------------
       Load / Save rows from localStorage
       ----------------------------------------- */
    function loadRows(){
        try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
    }
    function saveRows(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }

    /* -----------------------------------------
       RENDER: single table with category merged rows
       ----------------------------------------- */
    function render(){
        groupsContainer.innerHTML = '';

        const q = (searchInput.value || '').trim().toLowerCase();
        const filterCat = categoryFilter.value || '';

        // group rows by category
        const grouped = rows.reduce((acc, r)=>{
            const composite = [r.code, r.desc, r.category, r.group, r.item, r.class].join(' ').toLowerCase();
            if(q && !composite.includes(q)) return acc;
            if(filterCat && r.category !== filterCat) return acc;
            (acc[r.category] = acc[r.category] || []).push(r);
            return acc;
        }, {});

        // ensure we show categories from master set too (so empty categories appear)
        const allCatsSet = new Set([...categories, ...Object.keys(grouped)]);
        const allCats = Array.from(allCatsSet).sort((a,b)=> a.localeCompare(b)).filter(c => {
            if(!q && !filterCat) return true;
            return (grouped[c] && grouped[c].length) || (filterCat && c===filterCat);
        });

        if(allCats.length === 0){
            groupsContainer.innerHTML = '<div style="padding:18px">No results ‚Äî try clearing filters or adding accounts.</div>';
            return;
        }

        // build table DOM
        const tableWrap = document.createElement('div');
        tableWrap.className = 'single-table-wrap';

        const table = document.createElement('table');
        table.className = 'coa';
        table.innerHTML = `
        <thead>
          <tr>
            <th style="width:18%;">Code</th>
            <th style="width:44%;">Description (Account)</th>
            <th style="width:20%;">Group / Item</th>
            <th style="width:10%;">Class</th>
            <th style="width:8%;" class="action-th"></th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
        const tbody = table.querySelector('tbody');

        // append categories and their items
        allCats.forEach(cat => {
            const items = (grouped[cat] || []).slice().sort((a,b)=> (a.code||'').localeCompare(b.code||''));
            // category merged row (spans all cols)
            const catTr = document.createElement('tr');
            catTr.className = 'category-row';
            const catTd = document.createElement('td');
            catTd.colSpan = 5;
            catTd.textContent = `${cat}` + (items.length ? ` ‚Äî ${items.length} account(s)` : ' ‚Äî (empty)');
            catTr.appendChild(catTd);
            tbody.appendChild(catTr);

            // item rows
            items.forEach(it => {
                const tr = document.createElement('tr');
                tr.className = 'item-row';
                tr.innerHTML = `
            <td><div class="code-pill">${escapeHtml(it.code || '')}</div></td>
            <td>${escapeHtml(it.desc || '')}</td>
            <td>${escapeHtml((it.group || '') + (it.item ? ' / ' + it.item : ''))}</td>
            <td>${escapeHtml(it.class || '')}</td>
            <td class="action-col">
              <button class="btn tiny ghost edit">Edit</button>
              <button class="btn tiny ghost del">Delete</button>
            </td>
          `;
                // delete/edit handlers
                tr.querySelector('.del').addEventListener('click', ()=> {
                    if(!confirm(`Delete account "${it.code}"?`)) return;
                    const ix = rows.findIndex(r=> r.code===it.code && r.desc===it.desc && r.class===it.class && r.category===it.category);
                    if(ix >= 0) { rows.splice(ix,1); syncCategories(); saveRows(); render(); }
                });
                tr.querySelector('.edit').addEventListener('click', ()=> enterEditMode(it, tr));
                tbody.appendChild(tr);
            });
        });

        tableWrap.appendChild(table);
        groupsContainer.appendChild(tableWrap);

        // after inserting table into DOM, set up sticky category detection
        setupStickyCategoryDetection(tableWrap);
    }

    /* -----------------------------------------
       Edit mode (inline, uses colspan=5)
       ----------------------------------------- */
    function enterEditMode(item, rowEl){
        const parentTbody = rowEl.parentElement;
        const idxGlobal = rows.findIndex(r=> r.code===item.code && r.desc===item.desc && r.class===item.class && r.category===item.category);
        if(idxGlobal < 0) return;

        const trForm = document.createElement('tr');
        trForm.innerHTML = `<td colspan="5" style="padding:10px;background:#fbfbfb;border-radius:8px">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input class="edit" id="e_code" value="${escapeAttr(item.code)}" style="min-width:160px" />
          <input class="edit" id="e_desc" value="${escapeAttr(item.desc)}" style="flex:1" />
          <input class="edit" id="e_group" value="${escapeAttr(item.group)}" style="min-width:140px" placeholder="Group" />
          <input class="edit" id="e_item" value="${escapeAttr(item.item)}" style="min-width:120px" placeholder="Item" />
          <select id="e_class" class="edit" style="min-width:120px">
            <option value='Revenue'>Revenue</option><option value='Expenditure'>Expenditure</option>
          </select>
          <select id="e_category" class="edit" style="min-width:160px"></select>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button id="saveEdit" class="btn primary">Save</button>
            <button id="cancelEdit" class="btn ghost">Cancel</button>
          </div>
        </div>
      </td>`;
        parentTbody.replaceChild(trForm, rowEl);

        const eCategory = trForm.querySelector('#e_category');
        Array.from(categories).sort().forEach(c => {
            const opt = document.createElement('option'); opt.value = c; opt.textContent = c; eCategory.appendChild(opt);
        });
        eCategory.value = item.category || Array.from(categories)[0] || '';
        trForm.querySelector('#e_class').value = item.class || 'Revenue';
        trForm.querySelector('#cancelEdit').addEventListener('click', ()=> render());
        trForm.querySelector('#saveEdit').addEventListener('click', ()=> {
            const newCode = trForm.querySelector('#e_code').value.trim();
            const newDesc = trForm.querySelector('#e_desc').value.trim();
            const newGroup = trForm.querySelector('#e_group').value.trim();
            const newItem = trForm.querySelector('#e_item').value.trim();
            const newClass = trForm.querySelector('#e_class').value;
            const newCategory = trForm.querySelector('#e_category').value || 'Uncategorized';
            if(!newCode || !newDesc){ alert('Please supply both Code and Description'); return; }
            rows[idxGlobal] = { code:newCode, desc:newDesc, category:newCategory, group:newGroup, item:newItem, class:newClass };
            syncCategories(); saveRows(); render();
        });
    }

    /* -----------------------------------------
       Quick add handlers
       ----------------------------------------- */
    document.getElementById('addRevenueBtn').addEventListener('click', ()=> {
        const acc = document.getElementById('revAccount').value.trim();
        const code = document.getElementById('revCode').value.trim();
        const cat = document.getElementById('revCategory').value || 'Uncategorized';
        const group = document.getElementById('revGroup').value.trim();
        const item = document.getElementById('revItem').value.trim();
        if(!acc || !code){ alert('Please provide Account name and Code'); return; }
        rows.unshift({ code, desc:acc, category:cat, group, item, class:'Revenue' });
        syncCategories(); saveRows(); render();
        document.getElementById('revAccount').value=''; document.getElementById('revCode').value=''; document.getElementById('revGroup').value=''; document.getElementById('revItem').value='';
    });

    document.getElementById('addExpenditureBtn').addEventListener('click', ()=> {
        const acc = document.getElementById('expAccount').value.trim();
        const code = document.getElementById('expCode').value.trim();
        const cat = document.getElementById('expCategory').value || 'Uncategorized';
        const group = document.getElementById('expGroup').value.trim();
        const item = document.getElementById('expItem').value.trim();
        if(!acc || !code){ alert('Please provide Account name and Code'); return; }
        rows.unshift({ code, desc:acc, category:cat, group, item, class:'Expenditure' });
        syncCategories(); saveRows(); render();
        document.getElementById('expAccount').value=''; document.getElementById('expCode').value=''; document.getElementById('expGroup').value=''; document.getElementById('expItem').value='';
    });

    /* -----------------------------------------
       Add Category: add to master list and show an empty category in the table
       ----------------------------------------- */
    addCategoryBtn.addEventListener('click', ()=> {
        const name = prompt('New category name:');
        if(!name) return;
        const trimmed = name.trim();
        if(!trimmed) return;
        categories.add(trimmed);
        refreshCategoryControls();
        saveRows();
        render();
        try { revCategory.value = trimmed; expCategory.value = trimmed; } catch(e){}
    });

    /* -----------------------------------------
       CSV Import (simple) & Export
       ----------------------------------------- */
    importCsv.addEventListener('change', (e)=> {
        const file = e.target.files && e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(ev){
            const text = ev.target.result;
            const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
            let imported = 0;
            lines.forEach((ln) => {
                const cols = csvParseLine(ln);
                if(cols.length < 2) return;
                const code = cols[0] || '';
                const desc = cols[1] || '';
                const category = cols[2] || 'Uncategorized';
                const group = cols[3] || '';
                const item = cols[4] || '';
                const cls = cols[5] || 'Revenue';
                if(!code && !desc) return;
                rows.push({ code, desc, category, group, item, class: cls });
                imported++;
            });
            if(imported > 0){ syncCategories(); saveRows(); render(); alert('Imported ' + imported + ' rows.'); }
            else alert('No valid rows found in CSV.');
        };
        reader.readAsText(file);
        e.target.value = '';
    });

    exportCsvBtn.addEventListener('click', ()=> {
        const hdr = ['Code','Description','Category','Group','Item','Class'];
        const lines = [hdr.join(',')];
        rows.forEach(r => {
            const cols = [r.code||'', r.desc||'', r.category||'', r.group||'', r.item||'', r.class||'Revenue'];
            lines.push(cols.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(','));
        });
        const csv = lines.join('\n');
        const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'charts_of_accounts.csv'; a.click(); URL.revokeObjectURL(url);
    });

    function csvParseLine(line){
        const out = []; let cur = '', inQuote = false;
        for(let i=0;i<line.length;i++){
            const ch = line[i];
            if(inQuote){
                if(ch === '"'){ if(line[i+1] === '"'){ cur += '"'; i++; } else inQuote = false; } else cur += ch;
            } else {
                if(ch === '"'){ inQuote = true; } else if(ch === ','){ out.push(cur); cur = ''; } else cur += ch;
            }
        }
        out.push(cur); return out;
    }

    /* -----------------------------------------
       Search + filter handlers
       ----------------------------------------- */
    searchInput.addEventListener('input', ()=> render());
    categoryFilter.addEventListener('change', ()=> render());

    /* -----------------------------------------
       Category sync helper
       ----------------------------------------- */
    function syncCategories(){
        categories = new Set(rows.map(r=> r.category || 'Uncategorized'));
        refreshCategoryControls();
    }
    function refreshCategoryControls(){
        const all = Array.from(new Set([...categories].sort((a,b)=> a.localeCompare(b))));
        [revCategory, expCategory, categoryFilter].forEach(sel=>{
            if(!sel) return;
            if(sel === categoryFilter){
                const defaultOpt = '<option value="">All Categories</option>';
                sel.innerHTML = defaultOpt + all.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
            } else {
                sel.innerHTML = all.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
            }
        });
    }

    /* -----------------------------------------
       Sticky Category Detection
       - CSS makes category rows sticky at top offset.
       - We add / remove .stuck class (darken) depending on scroll.
       Implementation approach:
         - Listen to scroll on .single-table-wrap
         - For each category row, compute its boundingClientRect relative to the container and
           mark the one that is closest to (or <=) the header offset as stuck.
       ----------------------------------------- */
    let lastStuck = null;
    function setupStickyCategoryDetection(tableWrap){
        // clean up existing listener if any (rudimentary)
        const existing = tableWrap._stickyListener;
        if(existing) tableWrap.removeEventListener('scroll', existing);

        function onScroll(){
            const headerOffset = tableWrap.getBoundingClientRect().top + parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height')) ;
            // find category rows inside this tableWrap
            const catRows = tableWrap.querySelectorAll('tr.category-row');
            let candidate = null;
            // We will find the last category row whose top is <= headerOffset (i.e., that should be active)
            for(const r of catRows){
                const rRect = r.getBoundingClientRect();
                // rRect.top is relative to viewport. Compare to headerOffset (viewport position)
                if(rRect.top <= headerOffset){
                    candidate = r;
                }
            }
            // toggle stuck class
            if(lastStuck && lastStuck !== candidate) lastStuck.classList.remove('stuck');
            if(candidate){
                candidate.classList.add('stuck');
            }
            lastStuck = candidate;
        }

        // run once to initialize
        onScroll();
        // attach
        tableWrap.addEventListener('scroll', onScroll);
        // store listener so we can remove later if tableWrap replaced
        tableWrap._stickyListener = onScroll;
    }

    /* -----------------------------------------
       PRINT: Modal + three modes
       - Clean: black & white minimal
       - Professional: Title + optional company + date + page numbers
       - As-Is: open browser print of current view (but hide UI via @media print)
       Implementation: open a new window with isolated print HTML (avoids CSS bleed & makes headers repeat)
       ----------------------------------------- */
    printBtn.addEventListener('click', openPrintModal);
    printClose.addEventListener('click', closePrintModal);

    document.getElementById('btnPrintClean').addEventListener('click', ()=> {
        const tbl = getRenderedTable();
        if(!tbl){ alert('No table to print'); closePrintModal(); return; }
        const html = buildPrintDoc(tbl.outerHTML, { mode:'clean' });
        openPrintWindow(html);
        closePrintModal();
    });

    document.getElementById('btnPrintAsIs').addEventListener('click', ()=> {
        const tbl = getRenderedTable();
        if(!tbl){ alert('No table to print'); closePrintModal(); return; }
        const html = buildPrintDoc(tbl.outerHTML, { mode:'asis' });
        openPrintWindow(html);
        closePrintModal();
    });

    document.getElementById('btnPrintProfessional').addEventListener('click', ()=> {
        const tbl = getRenderedTable();
        if(!tbl){ alert('No table to print'); closePrintModal(); return; }
        const company = (printCompany.value || '').trim();
        const html = buildPrintDoc(tbl.outerHTML, { mode:'professional', company });
        openPrintWindow(html);
        closePrintModal();
    });

    function openPrintModal(){
        printModal.classList.add('open');
        printModal.setAttribute('aria-hidden','false');
        printCompany.value = '';
        printCompany.focus();
    }
    function closePrintModal(){
        printModal.classList.remove('open');
        printModal.setAttribute('aria-hidden','true');
    }

    // returns cloned table node (so DOM not mutated)
    function getRenderedTable(){
        const wrap = document.querySelector('.single-table-wrap');
        if(!wrap) return null;
        const tbl = wrap.querySelector('table.coa');
        return tbl ? tbl.cloneNode(true) : null;
    }

    // builds an isolated print HTML document string for a mode
    function buildPrintDoc(tableHtml, opts = { mode:'clean', company:'' }){
        const mode = opts.mode || 'clean';
        const company = opts.company || '';
        const title = 'Chart of Accounts';
        const date = new Date().toLocaleDateString();

        const baseCss = `
        <style>
          @media print { @page { margin: 20mm; } thead { display: table-header-group; } }
          body{font-family:Inter,system-ui,Arial;margin:12px;color:#111}
          table{width:100%; border-collapse:collapse; font-size:12px}
          thead th{padding:8px; font-weight:700; border-bottom:1px solid #bbb; text-align:left}
          tbody td{padding:8px; border-bottom:1px solid #e6e6e6}
          .cat-row td{padding:10px; font-weight:800; text-transform:uppercase; background:transparent}
        </style>
      `;

        let modeCss = '';
        if(mode === 'clean'){
            modeCss = `
          <style>
            thead th{background:#fff;color:#000}
            table, th, td{border:1px solid #bbb}
            .cat-row td{background:#eee}
          </style>
        `;
        } else if(mode === 'asis'){
            modeCss = `
          <style>
            thead th{background:#f3f4f6}
            table, th, td{border:1px solid #e6e7e8}
            .cat-row td{background:#f7fbf8}
          </style>
        `;
        } else if(mode === 'professional'){
            modeCss = `
          <style>
            @page { margin: 18mm; }
            .report-header{margin-bottom:8px}
            .report-title{font-size:18px;font-weight:800;margin:0}
            .report-company{font-size:14px;color:#333;margin:2px 0}
            .report-meta{font-size:12px;color:#666;margin-bottom:8px}
            thead th{background:#f3f4f6;color:#111}
            table, th, td{border:1px solid #e6e7e8}
            .cat-row td{background:#f7fbf8}
            .page-footer{position:fixed;bottom:0;left:0;right:0;height:22px;padding:6px 10px;border-top:1px solid #ddd;color:#666;font-size:12px}
            .page-footer:after { content: "Page " counter(page); float:right; }
            @media print { .page-footer{position:fixed;bottom:0} }
          </style>
        `;
        }

        const headerHtml = mode === 'professional' ? `
        <div class="report-header">
          <div class="report-title">${escapeHtml(title)}</div>
          ${company ? `<div class="report-company">${escapeHtml(company)}</div>` : ''}
          <div class="report-meta">Printed: ${escapeHtml(date)}</div>
        </div>
      ` : '';

        // final HTML
        const final = `
        <!doctype html>
        <html>
          <head><meta charset="utf-8"/><title>Print - ${title}</title>${baseCss}${modeCss}</head>
          <body>
            <div class="print-container">
              ${headerHtml}
              ${tableHtml}
            </div>
            ${mode === 'professional' ? `<div class="page-footer">Generated by COA</div>` : ''}
            <script>
              (function(){
                const tbl = document.querySelector('table');
                if(!tbl) return;
                Array.from(tbl.querySelectorAll('tr')).forEach(tr => {
                  const td = tr.querySelector('td[colspan]');
                  if(td) tr.classList.add('cat-row');
                });
                setTimeout(()=>{ window.print(); },120);
              })();

`;
return final;
}

// open new window and write the print doc
function openPrintWindow(html){
const w = window.open('', '_blank', 'noopener');
if(!w){ alert('Pop-up blocked. Allow pop-ups for this site or use Print As-Is via browser print.'); return; }
w.document.open();
w.document.write(html);
w.document.close();
// attempt to close after a small delay (not fully reliable across browsers)
setTimeout(()=>{ try{ w.close(); } catch(e){} }, 2000);
}

/* -----------------------------------------
Sticky detection housekeeping:
- attach scroll listener for the current tableWrap
- when user resizes window, re-run render so positions update
----------------------------------------- */
window.addEventListener('resize', ()=> {
// re-render to reset sticky listeners & positions (cheap but reliable)
render();
});

/* -----------------------------------------
Utility helpers: escaping
----------------------------------------- */
function escapeHtml(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeAttr(s){ return String(s || '').replace(/"/g,'&quot;'); }

/* -----------------------------------------
INITIALIZE
----------------------------------------- */
refreshCategoryControls();
render();

</script>
</body>
</html>
