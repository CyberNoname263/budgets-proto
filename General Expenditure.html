<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>General Expenditure</title>

    <link rel="stylesheet" href="General Expenditure.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>

<!-- Taskbar -->
<nav class="taskbar">


    <button id="ToggleBtn" class="task-button toggle-btn" title="Menu" onclick="toggleDropdown('coneDropdown')">
        <i class="fa-solid fa-bars"></i>
    </button>


    <!-- Include this inside <body> -->
    <button class="task-button" id="Home_btn">
        <i class="fa-solid fa-house"></i>
        <span class="underline">Home</span>
    </button>

    <button class="task-button" id="Print_btn">
        <i class="fa-solid fa-print"></i><span class="underline">Print</span>
    </button>
    <button class="task-button" id="Import_btn">
        <i class="fa-solid fa-file-import"></i><span class="underline">Import</span>
    </button>

    <!-- Dropdown Menu -->
    <div id="coneDropdown" class="dropdown-menu" style="display:none; position:absolute; left:10px; top:44px; z-index:1200;">
        <button class="dropdown-item" id="AddNew_btn"><i class="fa-solid fa-plus"></i> Add New</button>
        <button class="dropdown-item" id="Save_btn"><i class="fa-solid fa-floppy-disk"></i> Save</button>
        <button class="dropdown-item" id="SaveAs_btn"><i class="fa-regular fa-floppy-disk"></i> Save As</button>
        <button class="dropdown-item" id="Open_btn"><i class="fa-solid fa-folder-open"></i> Open</button>
        <button class="dropdown-item" id="Account_btn"><i class="fa-solid fa-user-circle"></i> Account</button>
        <button class="dropdown-item" id="Close_btn"><i class="fa-solid fa-xmark"></i> Close</button>
    </div>
</nav>

<!-- Main layout -->
<div class="left-container">
    <h2 class="headerGraph">Inputs & Graphics</h2>

    <div class="form-container" id="formContainer">
        <h2>Expenditure Details</h2>
        <form id="expenditureForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="expenditure_class">Expenditure Class:</label>
                    <select id="expenditure_class" required>
                        <option value="">Select Class</option>
                        <option value="Utilities and Other Service Charges">Utilities and Other Service Charges</option>
                        <option value="Institutional Provisions">Institutional Provisions</option>
                        <option value="Capital Expenditure">Capital Expenditure</option>
                        <option value="Compensation of Employees">Compensation Of Employees</option>
                        <option value="Chemicals Fertiliser And Animal Feed">Chemicals Fertiliser And Animal Feed</option>
                        <option value="Physical Repairs">Physical Repairs</option>
                        <option value="Communication And Information Supplies And Services">Communication And Information Supplies And Services</option>
                        <option value="Financial Transactions Expenses">Financial Transactions Expenses</option>
                        <option value="Other Expense Goods And Services Not Classified Above">Other Expense Goods And Services Not Classified Above</option>
                        <option value="Hospitality">Hospitality</option>
                        <option value="Office Supplies and Services">Office Supplies and Services</option>
                        <option value="Rental And Hire Services">Rental And Hire Services</option>
                        <option value="Training And Development Expenses">Training And Development Expenses</option>
                        <option value="Domestic Travel Expenses">Domestic Travel Expenses</option>
                        <option value="Foreign Travel Expenses">Foreign Travel Expenses</option>
                        <option value="Technical And Office Equipment Repairs">Technical And Office Equipment Repairs</option>
                        <option value="Physical Maintenance">Physical Maintenance</option>
                        <option value="Vehicle And Mobile Equipment Repairs">Vehicle And Mobile Equipment Repairs</option>
                        <option value="Technical And Office Equipment Maintenance">Technical And Office Equipment Maintenance</option>
                        <option value="Vehicle And Mobile Equipment Maintenance">Vehicle And Mobile Equipment Maintenance</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="expenditure_item">Expenditure Item:</label>
                    <input type="text" id="expenditure_item" required />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="details">Details:</label>
                    <input type="text" id="details" required />
                </div>
                <div class="form-group">
                    <label for="units">Units:</label>
                    <input type="number" id="units" required min="0" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="frequency">Frequency:</label>
                    <!-- value is text, data-mult used for calculations -->
                    <select id="frequency" required>
                        <option value="">Select Frequency</option>
                        <option value="Instance" data-mult="1">Instance</option>
                        <option value="Twice" data-mult="2">Twice</option>
                        <option value="Thrice" data-mult="3">Thrice</option>
                        <option value="Quarterly" data-mult="4">Quarterly</option>
                        <option value="Daily" data-mult="365">Daily</option>
                        <option value="Weekly" data-mult="52">Weekly</option>
                        <option value="Monthly" data-mult="12">Monthly</option>
                        <option value="Annually" data-mult="1">Annually</option>
                        <option value="Bi-Annually" data-mult="2">Bi-Annually</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="number">Number:</label>
                    <input type="number" id="number" required min="0" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="charge">Charge:</label>
                    <input placeholder="$" type="number" id="charge" required min="0" step="0.01" />
                </div>

                <div class="form-group">
                    <label for="totalAmount">Total Amount:</label>
                    <input placeholder="$" type="number" id="totalAmount" required readonly />
                </div>
            </div>

            <div class="form-buttons">
                <button type="submit">Submit</button>
                <button type="button" class="clear-btn" id="clearBtn">Clear</button>
                <button type="button" id="openFormulaManager" title="Manage formulas">Formulas</button>
            </div>
        </form>
    </div>

    <!-- Chart area with Recalculate button and legend -->
    <div class="chart-container">
        <button id="recalcBtn" title="Recalculate all rows">üîÅ Recalculate Totals</button>
        <div style="flex:1; display:flex; align-items:center; justify-content:center; width:100%;">
            <canvas id="expenditureChart"></canvas>
        </div>
        <div id="chartLegend" class="chart-legend"></div>
    </div>
</div>

<!-- Right side: search & table -->
<div class="right-container">
    <div class="form-container">
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Search" />
            <button class="search-btn" onclick="searchTable()">Search</button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
            <tr>
                <th>#</th>
                <th>Expenditure Class</th>
                <th>Expenditure Item</th>
                <th>Details</th>
                <th>Units</th>
                <th>Frequency</th>
                <th>Number</th>
                <th>Charge($)</th>
                <th>Total Amount($)</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Hidden file input for import -->
<input type="file" id="fileInput" accept=".csv, .xlsx, .xls" style="display:none" />
<div id="importStatus" class="import-status" aria-live="polite" style="display:none"></div>

<!-- custom context menu for table/search -->
<ul id="contextMenu" class="context-menu">
    <li data-action="cut">‚úÇÔ∏è Cut</li>
    <li data-action="copy">üìã Copy</li>
    <li data-action="paste">üì• Paste</li>
    <li data-action="insert">‚ûï Insert Row Below</li>
    <li data-action="delete">üóë Delete Row</li>
    <li data-action="clear">üßπ Clear Cell</li>
</ul>

<!-- Formula context menu & dialog -->
<div id="formulaMenu" class="custom-context-menu" style="display:none;position:absolute;z-index:1000;background:#fff;border:1px solid #ddd;padding:6px;border-radius:6px;">
    <ul style="list-style:none;margin:0;padding:0;">
        <li id="newFormula" style="padding:6px;cursor:pointer;"><i class="fa-solid fa-square-root-variable"></i> New Formula</li>
        <li id="recentFormula" style="padding:6px;cursor:pointer;"><i class="fa-solid fa-clock-rotate-left"></i> Use Most Recent Formula</li>
        <li id="popularFormula" style="padding:6px;cursor:pointer;"><i class="fa-solid fa-chart-line"></i> Mostly Used Formula</li>
    </ul>
</div>

<div id="formulaDialog" class="formula-dialog" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1100;background:#fff;padding:16px;border-radius:8px;box-shadow:0 12px 40px rgba(0,0,0,0.12);width:420px;">
    <div class="formula-dialog-content">
        <h3>üßÆ Create or Test Formula</h3>
        <label for="formulaName">Formula Name:</label>
        <input type="text" id="formulaName" placeholder="e.g., Default Formula" style="width:100%;box-sizing:border-box;margin-bottom:8px;" />
        <label for="formulaExpression">Expression:</label>
        <textarea id="formulaExpression" rows="3" placeholder="e.g., frequency * number * charge * units" style="width:100%;box-sizing:border-box;"></textarea>
        <hr />
        <h4>üîç Test Formula</h4>
        <div class="test-grid" style="display:flex;gap:6px;margin-bottom:8px;">
            <input type="text" id="testFrequency" placeholder="frequency" style="flex:1" />
            <input type="text" id="testNumber" placeholder="number" style="flex:1" />
            <input type="text" id="testCharge" placeholder="charge" style="flex:1" />
            <input type="text" id="testUnits" placeholder="units" style="flex:1" />
        </div>
        <button id="testFormulaBtn">Test Formula</button>
        <div id="testResult" style="margin-top:8px;"></div>
        <div class="dialog-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
            <button id="saveFormulaBtn">Save Formula</button>
            <button id="cancelFormulaBtn">Cancel</button>
        </div>
    </div>
</div>

<!-- Formulas manager -->
<div id="formulaManager">
    <h4>Saved formulas</h4>
    <div id="formulaList"></div>
    <div style="text-align:right;margin-top:8px;">
        <button id="closeFormulaManager" style="padding:6px 10px;border-radius:6px;border:none;background:#eee;cursor:pointer;">Close</button>
    </div>
</div>

<!-- Save As modal and Account/Print/others you already had can be re-used; omitted for brevity here -->

<script>
    /* ---------------------------
       Utilities & Config
       --------------------------- */
    const tableTbody = document.querySelector(".table-container table tbody");
    const exportSaveKey = "expenditureTable_v1"; // key for localStorage
    const formulasKey = "expenditureFormulas_v1";
    let unsavedChanges = false;

    /* frequency text -> multiplier map */
    const frequencyMultipliers = {
        "Instance": 1,
        "Daily": 365,
        "Weekly": 52,
        "Monthly": 12,
        "Annually": 1,
        "Bi-Annually": 2,
        "Quarterly": 4,
        "Thrice": 3,
        "Twice": 2
    };

    /* color generator for consistency */
    function colorForClass(name) {
        if (!name) return "#CCCCCC";
        let hash = 0;
        for (let i = 0; i < name.length; i++) hash = (hash << 5) - hash + name.charCodeAt(i);
        const hue = Math.abs(hash) % 360;
        return `hsl(${hue}, 65%, 55%)`;
    }

    /* ---------------------------
       Persistence: save / load table
       --------------------------- */
    function saveTableToStorage() {
        const rows = [];
        document.querySelectorAll(".table-container table tbody tr").forEach(tr => {
            const cells = Array.from(tr.cells).map(td => td.textContent.trim());
            if (cells.length && cells.some(c => c !== "")) rows.push(cells);
        });
        localStorage.setItem(exportSaveKey, JSON.stringify(rows));
        unsavedChanges = false;
    }

    function loadTableFromStorage() {
        const raw = localStorage.getItem(exportSaveKey);
        if (!raw) return false;
        try {
            const rows = JSON.parse(raw);
            if (!Array.isArray(rows) || rows.length === 0) return false;
            tableTbody.innerHTML = "";
            rows.forEach(cells => {
                const tr = tableTbody.insertRow();
                cells.forEach((text, idx) => {
                    const td = tr.insertCell(idx);
                    td.textContent = text;
                    td.contentEditable = idx !== 0; // allow editing except index
                    td.tabIndex = 0;
                });
                tr.onclick = () => selectRow(tr);
            });
            updateRowNumbers();
            return true;
        } catch (err) {
            console.error("loadTableFromStorage error:", err);
            return false;
        }
    }

    /* ---------------------------
       Row utilities
       --------------------------- */
    function updateRowNumbers() {
        const rows = document.querySelectorAll(".table-container table tbody tr");
        let c = 1;
        rows.forEach(row => {
            if (row.style.display === "none") return;
            if (!row.cells[0]) row.insertCell(0);
            row.cells[0].textContent = c++;
        });
    }

    /* ---------------------------
       Form: auto-calculation of total (before submit)
       --------------------------- */
    function getFrequencyMultiplierFromSelect(selectEl) {
        const opt = selectEl.options[selectEl.selectedIndex];
        if (!opt) return 1;
        const dm = opt.getAttribute("data-mult");
        if (dm) return parseFloat(dm) || 1;
        const text = opt.value || opt.text;
        return frequencyMultipliers[text] || 1;
    }

    function updateTotalAmountInput() {
        const units = parseFloat(document.getElementById("units").value) || 0;
        const number = parseFloat(document.getElementById("number").value) || 0;
        const charge = parseFloat(document.getElementById("charge").value) || 0;
        const freqMultiplier = getFrequencyMultiplierFromSelect(document.getElementById("frequency"));
        const total = units * number * charge * freqMultiplier;
        document.getElementById("totalAmount").value = isFinite(total) ? total.toFixed(2) : "0.00";
    }

    /* attach live calculation to inputs */
    ["units","number","charge","frequency"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", updateTotalAmountInput);
        if (el) el.addEventListener("change", updateTotalAmountInput);
    });

    /* ---------------------------
       Form submit handler (single)
       --------------------------- */
    let selectedRow = null;

    document.getElementById("expenditureForm").addEventListener("submit", (e) => {
        e.preventDefault();

        const cls = document.getElementById("expenditure_class").value.trim();
        const item = document.getElementById("expenditure_item").value.trim();
        const details = document.getElementById("details").value.trim();
        const units = parseFloat(document.getElementById("units").value) || 0;
        const freqSelect = document.getElementById("frequency");
        const freqText = freqSelect.options[freqSelect.selectedIndex]?.value || "";
        const freqMultiplier = getFrequencyMultiplierFromSelect(freqSelect);
        const number = parseFloat(document.getElementById("number").value) || 0;
        const charge = parseFloat(document.getElementById("charge").value) || 0;
        const total = units * number * charge * freqMultiplier;

        const unitsStr = (units || units === 0) ? units.toString() : "";
        const numberStr = (number || number === 0) ? number.toString() : "";
        const chargeStr = isFinite(charge) ? Number(charge).toFixed(2) : "";
        const totalStr = isFinite(total) ? Number(total).toFixed(2) : "0.00";

        if (selectedRow) {
            // Update existing selected row
            selectedRow.cells[1].textContent = cls;
            selectedRow.cells[2].textContent = item;
            selectedRow.cells[3].textContent = details;
            selectedRow.cells[4].textContent = unitsStr;
            selectedRow.cells[5].textContent = freqText;
            selectedRow.cells[6].textContent = numberStr;
            selectedRow.cells[7].textContent = chargeStr;
            selectedRow.cells[8].textContent = totalStr;
            selectedRow = null;
        } else {
            // Add new row
            const tr = tableTbody.insertRow();
            tr.insertCell(0).textContent = ""; // placeholder
            tr.insertCell(1).textContent = cls;
            tr.insertCell(2).textContent = item;
            tr.insertCell(3).textContent = details;
            tr.insertCell(4).textContent = unitsStr;
            tr.insertCell(5).textContent = freqText;
            tr.insertCell(6).textContent = numberStr;
            tr.insertCell(7).textContent = chargeStr;
            tr.insertCell(8).textContent = totalStr;
            tr.onclick = () => selectRow(tr);

            // Make editable cells focusable
            Array.from(tr.cells).forEach((td, idx) => {
                td.contentEditable = idx !== 0; // keep # not editable
                td.tabIndex = 0;
            });
        }

        // Clear form & update
        document.getElementById("expenditureForm").reset();
        document.getElementById("totalAmount").value = "";
        updateRowNumbers();
        saveTableToStorage();
        updateChart();
    });

    /* select a row for editing */
    function selectRow(row) {
        selectedRow = row;
        document.getElementById('expenditure_class').value = row.cells[1].textContent;
        document.getElementById('expenditure_item').value = row.cells[2].textContent;
        document.getElementById('details').value = row.cells[3].textContent;
        document.getElementById('units').value = row.cells[4].textContent;
        // set frequency select by matching the option value text
        const freqVal = row.cells[5].textContent;
        const frequencySelect = document.getElementById("frequency");
        Array.from(frequencySelect.options).forEach(opt => { opt.selected = (opt.value === freqVal); });
        document.getElementById('number').value = row.cells[6].textContent;
        document.getElementById('charge').value = row.cells[7].textContent;
        document.getElementById('totalAmount').value = row.cells[8].textContent;
    }

    /* Clear button */
    document.getElementById("clearBtn").addEventListener("click", () => {
        document.getElementById("expenditureForm").reset();
        selectedRow = null;
    });

    /* ---------------------------
       Import & populate table
       --------------------------- */
    const importBtn = document.getElementById("Import_btn");
    const fileInput = document.getElementById("fileInput");
    const importStatus = document.getElementById("importStatus");

    importBtn.addEventListener("click", () => { fileInput.value = ""; fileInput.click(); });

    function showStatus(message, type = "info") {
        importStatus.style.display = "flex";
        importStatus.textContent = message;
        if (type === "success" || type === "error") setTimeout(()=>importStatus.style.display="none", 3500);
    }

    fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const name = file.name.toLowerCase();
        showStatus(`Importing ${file.name} ...`);
        const reader = new FileReader();

        if (name.endsWith(".csv")) {
            reader.onload = (e) => {
                const raw = e.target.result;
                const rows = raw.split(/\r?\n/).map(r => r.split(",").map(c => c.trim()));
                populateTableFromArray(rows);
                showStatus("CSV imported", "success");
            };
            reader.readAsText(file);
        } else {
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: "array" });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
                populateTableFromArray(rows);
                showStatus("Excel imported", "success");
            };
            reader.readAsArrayBuffer(file);
        }
    });

    function mapFrequencyValue(v) {
        if (!v) return "";
        v = String(v).trim();
        for (const opt of document.getElementById("frequency").options) {
            if (opt.value.toLowerCase() === v.toLowerCase()) return opt.value;
        }
        const numeric = parseFloat(v);
        if (!isNaN(numeric)) {
            for (const [text, mult] of Object.entries(frequencyMultipliers)) {
                if (Number(mult) === numeric) return text;
            }
            return String(v);
        }
        return v;
    }

    function populateTableFromArray(rows) {
        if (!Array.isArray(rows) || rows.length === 0) return;
        const header = rows[0].map(c => String(c||"").toLowerCase());
        const hasHeader = header.some(h => /expenditure|total|charge|units|frequency|number/.test(h));
        const startIndex = hasHeader ? 1 : 0;

        tableTbody.innerHTML = "";
        for (let i = startIndex; i < rows.length; i++) {
            if (!rows[i] || rows[i].join("").trim() === "") continue;
            const r = rows[i];
            const tr = tableTbody.insertRow();
            for (let c = 0; c < 9; c++) tr.insertCell();
            if (r.length >= 9) {
                tr.cells[1].textContent = r[1] || "";
                tr.cells[2].textContent = r[2] || "";
                tr.cells[3].textContent = r[3] || "";
                tr.cells[4].textContent = r[4] || "";
                tr.cells[5].textContent = mapFrequencyValue(r[5]);
                tr.cells[6].textContent = r[6] || "";
                tr.cells[7].textContent = r[7] || "";
                tr.cells[8].textContent = r[8] || computeRowTotalFromCells(tr);
            } else {
                tr.cells[1].textContent = r[0] || "";
                tr.cells[2].textContent = r[1] || "";
                tr.cells[3].textContent = r[2] || "";
                tr.cells[4].textContent = r[3] || "";
                tr.cells[5].textContent = mapFrequencyValue(r[4] || "");
                tr.cells[6].textContent = r[5] || "";
                tr.cells[7].textContent = r[6] || "";
                tr.cells[8].textContent = r[7] || computeRowTotalFromCells(tr);
            }

            Array.from(tr.cells).forEach((td, idx) => {
                td.contentEditable = idx !== 0;
                td.tabIndex = 0;
            });
            tr.onclick = () => selectRow(tr);
        }

        updateRowNumbers();
        saveTableToStorage();
        updateChart();
    }

    function computeRowTotalFromCells(tr) {
        try {
            const units = parseFloat(tr.cells[4].textContent) || 0;
            const freqText = tr.cells[5].textContent.trim();
            const number = parseFloat(tr.cells[6].textContent) || 0;
            const charge = parseFloat(tr.cells[7].textContent) || 0;
            const multiplier = frequencyMultipliers[freqText] || (parseFloat(freqText) || 1);
            const tot = units * number * charge * multiplier;
            return isFinite(tot) ? Number(tot).toFixed(2) : "0.00";
        } catch (e) {
            return "0.00";
        }
    }

    /* ---------------------------
       Recalculate totals button
       --------------------------- */
    document.getElementById("recalcBtn").addEventListener("click", () => {
        document.querySelectorAll(".table-container table tbody tr").forEach(tr => {
            const newTotal = computeRowTotalFromCells(tr);
            tr.cells[8].textContent = newTotal;
        });
        updateRowNumbers();
        saveTableToStorage();
        updateChart();
    });

    /* ---------------------------
       Chart (animated, color-coded, percentage tooltip, legend below, clickable)
       --------------------------- */
    let expenditureChart = null;
    let chartVisibility = {}; // className -> boolean visible

    function updateChart() {
        const rows = Array.from(document.querySelectorAll(".table-container table tbody tr")).filter(r => r.style.display !== "none");
        const agg = {};
        rows.forEach(r => {
            const cls = r.cells[1]?.textContent?.trim() || "(Unspecified)";
            const total = parseFloat(r.cells[8]?.textContent) || 0;
            if (!agg[cls]) agg[cls] = 0;
            agg[cls] += total;
        });

        const labels = Object.keys(agg);
        const data = labels.map(l => agg[l]);
        const colors = labels.map(l => colorForClass(l));

        // initialize visibility flags for newly discovered classes
        labels.forEach(l => { if (chartVisibility[l] === undefined) chartVisibility[l] = true; });

        const visibleData = data.map((v, i) => chartVisibility[labels[i]] ? v : 0);
        const ctx = document.getElementById("expenditureChart").getContext("2d");
        if (expenditureChart) expenditureChart.destroy();

        const totalSum = visibleData.reduce((s, v) => s + v, 0) || 1;

        expenditureChart = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels,
                datasets: [{
                    data: visibleData,
                    backgroundColor: colors,
                    borderColor: "#fff",
                    borderWidth: 2,
                    hoverOffset: 12
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { animateRotate: true, animateScale: true, duration: 900, easing: "easeOutQuart" },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const val = context.parsed;
                                const pct = ((val / totalSum) * 100).toFixed(2);
                                return `${context.label}: $${Number(val).toLocaleString()} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });

        // render custom legend
        const legend = document.getElementById("chartLegend");
        legend.innerHTML = "";
        labels.forEach((label, i) => {
            const item = document.createElement("div");
            item.className = "legend-item";
            if (!chartVisibility[label]) item.style.opacity = "0.45";
            const dot = document.createElement("span");
            dot.className = "legend-dot";
            dot.style.background = colors[i];
            const text = document.createElement("span");
            text.textContent = `${label} ‚Äî $${Number(data[i]).toLocaleString()}`;
            item.appendChild(dot);
            item.appendChild(text);
            item.addEventListener("click", () => {
                chartVisibility[label] = !chartVisibility[label];
                item.style.opacity = chartVisibility[label] ? "1" : "0.45";
                updateChart();
            });
            legend.appendChild(item);
        });
    }

    /* sync on manual edits */
    tableTbody.addEventListener("input", (ev) => {
        const td = ev.target.closest("td");
        if (!td) return;
        const tr = td.parentElement;
        tr.cells[8].textContent = computeRowTotalFromCells(tr);
        unsavedChanges = true;
        saveTableToStorage();
        updateChart();
    });

    tableTbody.addEventListener("blur", (ev) => {
        const td = ev.target.closest("td");
        if (!td) return;
        const tr = td.parentElement;
        tr.cells[8].textContent = computeRowTotalFromCells(tr);
        updateRowNumbers();
        unsavedChanges = true;
        saveTableToStorage();
        updateChart();
    }, true);

    /* ---------------------------
       initial load: restore table and chart
       --------------------------- */
    document.addEventListener("DOMContentLoaded", () => {
        const restored = loadTableFromStorage();
        if (!restored) tableTbody.innerHTML = "";
        updateRowNumbers();
        updateChart();
    });

    /* ---------------------------
       Search function
       --------------------------- */
    function searchTable() {
        const q = document.getElementById("searchInput").value.toLowerCase().trim();
        const rows = document.querySelectorAll(".table-container table tbody tr");
        rows.forEach(r => {
            const text = r.innerText.toLowerCase();
            r.style.display = text.includes(q) ? "" : "none";
        });
        updateRowNumbers();
        updateChart();
    }

    /* ---------------------------
       Top menu buttons hookup
       --------------------------- */
    function toggleDropdown(id) {
        const dropdown = document.getElementById(id);
        dropdown.style.display = dropdown.style.display === "flex" || dropdown.style.display === "block" ? "none" : "block";
    }

    // Hide dropdown when click outside
    document.addEventListener("click", function(ev) {
        const dd = document.getElementById("coneDropdown");
        const toggleBtn = document.getElementById("ToggleBtn");
        if (!dd.contains(ev.target) && !toggleBtn.contains(ev.target)) dd.style.display = "none";
    });

    // Add New (uses AddNew_btn)
    document.getElementById("AddNew_btn")?.addEventListener("click", () => {
        const existingTable = document.querySelector(".table-container table");
        if (!existingTable) return;
        const recoveryKey = "expenditureRecovery_v1";
        const prevHtml = existingTable.outerHTML;
        const list = JSON.parse(localStorage.getItem(recoveryKey) || "[]");
        list.push({ html: prevHtml, ts: new Date().toISOString() });
        localStorage.setItem(recoveryKey, JSON.stringify(list));
        tableTbody.innerHTML = "";
        updateRowNumbers();
        saveTableToStorage();
        updateChart();
        alert("New blank table created. Previous table saved to recovery list.");
    });

    // Save (export as excel)
    document.getElementById("Save_btn")?.addEventListener("click", () => {
        const table = document.querySelector(".table-container table");
        if (!table) return alert("No table to save");
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(table);
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, "ExpenditureData.xlsx");
        unsavedChanges = false;
    });

    // Save As - open small Save As dialog if it exists in page (many users have it), else trigger Save
    document.getElementById("SaveAs_btn")?.addEventListener("click", () => {
        const modal = document.getElementById("saveAsModal");
        if (modal) modal.style.display = "flex";
        else document.getElementById("Save_btn").click();
    });

    // Open
    document.getElementById("Open_btn")?.addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".csv, .xlsx, .xls";
        input.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            if (file.name.toLowerCase().endsWith(".csv")) {
                reader.onload = ev => {
                    const rows = ev.target.result.split(/\r?\n/).map(r => r.split(","));
                    populateTableFromArray(rows);
                };
                reader.readAsText(file);
            } else {
                reader.onload = ev => {
                    const data = new Uint8Array(ev.target.result);
                    const wb = XLSX.read(data, { type: "array" });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    populateTableFromArray(rows);
                };
                reader.readAsArrayBuffer(file);
            }
        });
        input.click();
    });

    // Account modal placeholder
    document.getElementById("Account_btn")?.addEventListener("click", () => {
        const modal = document.getElementById("accountModal");
        if (modal) modal.style.display = "flex";
        else alert("Account info not configured.");
    });

    // Close: confirmation if unsaved changes
    document.getElementById("Close_btn")?.addEventListener("click", () => {
        if (unsavedChanges) {
            if (!confirm("You have unsaved changes. Are you sure you want to close?")) return;
        }
        window.close();
    });

    /* Beforeunload confirmation */
    window.addEventListener("beforeunload", (e) => {
        if (unsavedChanges) {
            e.preventDefault();
            e.returnValue = "";
        }
    });

    /* ---------------------------
       Print handler
       --------------------------- */
    document.getElementById("Print_btn")?.addEventListener("click", () => {
        const tableHtml = document.querySelector(".table-container table").outerHTML;
        const w = window.open("", "", "width=1000,height=700");
        w.document.write(`<html><head><title>Print</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #000;padding:6px;text-align:left}</style></head><body>${tableHtml}</body></html>`);
        w.document.close();
        w.print();
    });

    /* ---------------------------
       Context menus: table/search and total input
       --------------------------- */
    const contextMenu = document.getElementById("contextMenu");
    let lastContextTarget = null;
    document.addEventListener("contextmenu", function(event) {
        const td = event.target.closest("td");
        const input = event.target.closest("#searchInput");
        const totalEl = event.target.closest("#totalAmount");
        if (totalEl) return; // handled separately by formulaMenu
        if (!td && !input) {
            contextMenu.style.display = "none";
            return;
        }
        event.preventDefault();
        lastContextTarget = td || input;
        contextMenu.style.left = event.pageX + "px";
        contextMenu.style.top = event.pageY + "px";
        contextMenu.style.display = "block";
    });
    document.addEventListener("click", () => { if (contextMenu) contextMenu.style.display = "none"; });

    contextMenu.addEventListener("click", (e) => {
        const action = e.target.getAttribute("data-action");
        if (!action || !lastContextTarget) return;
        if (action === "cut" || action === "copy" || action === "paste" || action === "clear") {
            if (lastContextTarget.tagName === "INPUT" || lastContextTarget.tagName === "TEXTAREA") {
                if (action === "cut") { lastContextTarget.select(); document.execCommand("cut"); }
                if (action === "copy") { lastContextTarget.select(); document.execCommand("copy"); }
                if (action === "paste") { lastContextTarget.focus(); document.execCommand("paste"); }
                if (action === "clear") lastContextTarget.value = "";
            } else { // table cell
                if (action === "cut") { document.execCommand("copy"); lastContextTarget.textContent = ""; }
                if (action === "copy") { document.execCommand("copy"); }
                if (action === "paste") { /* best-effort: user should use Ctrl+V */ }
                if (action === "clear") lastContextTarget.textContent = "";
                if (action === "delete") { // interpret delete as row delete
                    const row = lastContextTarget.parentElement;
                    row.remove();
                    updateRowNumbers();
                    saveTableToStorage();
                    updateChart();
                }
            }
        } else if (action === "insert") {
            if (lastContextTarget.tagName !== "TD") return;
            const row = lastContextTarget.parentElement;
            const newRow = row.parentElement.insertRow(row.rowIndex);
            for (let i=0; i<row.cells.length; i++) newRow.insertCell().contentEditable = i!==0;
            updateRowNumbers(); saveTableToStorage(); updateChart();
        } else if (action === "delete") {
            if (lastContextTarget.tagName === "TD") {
                lastContextTarget.parentElement.remove();
                updateRowNumbers(); saveTableToStorage(); updateChart();
            }
        }
        contextMenu.style.display = "none";
    });

    /* Formula menu for total input */
    const formulaMenu = document.getElementById("formulaMenu");
    const totalInput = document.getElementById("totalAmount");
    const formulaDialog = document.getElementById("formulaDialog");
    const saveFormulaBtn = document.getElementById("saveFormulaBtn");
    const cancelFormulaBtn = document.getElementById("cancelFormulaBtn");
    const testFormulaBtn = document.getElementById("testFormulaBtn");
    const testResult = document.getElementById("testResult");
    const nameInput = document.getElementById("formulaName");
    const exprInput = document.getElementById("formulaExpression");

    function getFormulas() { return JSON.parse(localStorage.getItem(formulasKey) || "[]"); }
    function saveFormulas(f) { localStorage.setItem(formulasKey, JSON.stringify(f)); updateFormulaListUI(); }

    if (totalInput) {
        totalInput.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            formulaMenu.style.display = "block";
            formulaMenu.style.left = e.pageX + "px";
            formulaMenu.style.top = e.pageY + "px";
        });
        document.addEventListener("click", (e) => {
            if (!formulaMenu.contains(e.target)) formulaMenu.style.display = "none";
        });
    }

    /* New/Recent/Popular formula handlers */
    document.getElementById("newFormula").addEventListener("click", () => {
        const f = getFormulas();
        const recent = f.length ? f[f.length - 1] : null;
        nameInput.value = recent?.name || "Default Formula";
        exprInput.value = recent?.expression || "frequency * number * charge * units";
        formulaDialog.style.display = "block";
    });
    document.getElementById("recentFormula").addEventListener("click", () => {
        const f = getFormulas();
        if (!f.length) return alert("No recent formula.");
        applyFormula(f[f.length - 1]);
    });
    document.getElementById("popularFormula").addEventListener("click", () => {
        const f = getFormulas();
        if (!f.length) return alert("No formulas.");
        const pop = f.reduce((a,b) => (a.usage||0) > (b.usage||0) ? a : b);
        applyFormula(pop);
    });
    cancelFormulaBtn.addEventListener("click", () => formulaDialog.style.display = "none");
    testFormulaBtn.addEventListener("click", () => {
        const expr = exprInput.value.trim();
        const frequency = parseFloat(document.getElementById('testFrequency').value) || 0;
        const number = parseFloat(document.getElementById('testNumber').value) || 0;
        const charge = parseFloat(document.getElementById('testCharge').value) || 0;
        const units = parseFloat(document.getElementById('testUnits').value) || 0;
        try {
            const result = eval(expr.replace(/frequency/g, frequency).replace(/number/g, number).replace(/charge/g, charge).replace(/units/g, units));
            testResult.innerText = `Result: ${!isNaN(result) ? Number(result).toFixed(2) : "Invalid"}`;
        } catch (err) {
            testResult.innerText = "‚ö†Ô∏è Invalid expression";
        }
    });
    saveFormulaBtn.addEventListener("click", () => {
        const name = nameInput.value.trim() || "Default Formula";
        const expression = exprInput.value.trim() || "frequency * number * charge * units";
        const f = getFormulas();
        f.push({ name, expression, usage: 0 });
        saveFormulas(f);
        formulaDialog.style.display = "none";
        alert(`Saved "${name}"`);
    });
    function applyFormula(formula) {
        try {
            const freqText = document.getElementById('frequency').value;
            const freqMult = frequencyMultipliers[freqText] || getFrequencyMultiplierFromSelect(document.getElementById('frequency'));
            const number = parseFloat(document.getElementById('number').value) || 0;
            const charge = parseFloat(document.getElementById('charge').value) || 0;
            const units = parseFloat(document.getElementById('units').value) || 0;
            const expr = formula.expression;
            const result = eval(expr.replace(/frequency/g, String(freqMult)).replace(/number/g, String(number)).replace(/charge/g, String(charge)).replace(/units/g, String(units)));
            if (!isNaN(result)) {
                document.getElementById('totalAmount').value = Number(result).toFixed(2);
                const f = getFormulas();
                const idx = f.findIndex(x => x.name === formula.name);
                if (idx !== -1) { f[idx].usage = (f[idx].usage || 0) + 1; saveFormulas(f); }
            }
        } catch (err) {
            console.error("applyFormula error", err);
            alert("Error applying formula");
        }
    }

    /* ---------------------------
       Formulas manager UI (list + delete)
       --------------------------- */
    const formulaManager = document.getElementById("formulaManager");
    const formulaList = document.getElementById("formulaList");
    document.getElementById("openFormulaManager")?.addEventListener("click", () => {
        updateFormulaListUI();
        formulaManager.style.display = "block";
    });
    document.getElementById("closeFormulaManager")?.addEventListener("click", () => formulaManager.style.display = "none");

    function updateFormulaListUI() {
        const f = getFormulas();
        formulaList.innerHTML = "";
        if (!f.length) { formulaList.innerHTML = "<div style='color:#666;padding:8px;'>No saved formulas</div>"; return; }
        f.forEach((ff, idx) => {
            const el = document.createElement("div");
            el.className = "formula-item";
            const left = document.createElement("div");
            left.innerHTML = `<strong>${ff.name}</strong><div style="font-size:12px;color:#666;">${ff.expression}</div>`;
            const right = document.createElement("div");
            const applyBtn = document.createElement("button"); applyBtn.textContent = "Apply"; applyBtn.addEventListener("click", () => applyFormula(ff));
            const delBtn = document.createElement("button"); delBtn.textContent = "Delete"; delBtn.addEventListener("click", () => {
                if (!confirm(`Delete formula "${ff.name}"?`)) return;
                const list = getFormulas(); list.splice(idx,1); saveFormulas(list); updateFormulaListUI();
            });
            right.appendChild(applyBtn); right.appendChild(delBtn);
            el.appendChild(left); el.appendChild(right);
            formulaList.appendChild(el);
        });
    }

    /* ---------------------------
       SaveAs (if modal exists) - hookup confirmSaveAsBtn if present
       --------------------------- */
    const confirmSaveAsBtn = document.getElementById("confirmSaveAsBtn");
    if (confirmSaveAsBtn) {
        confirmSaveAsBtn.addEventListener("click", () => {
            const table = document.querySelector(".table-container table");
            if (!table) return alert("No data to save!");
            const fileNameEl = document.getElementById("saveFileName");
            const fileTypeEl = document.getElementById("saveFileType");
            const fileName = fileNameEl ? fileNameEl.value.trim() || "ExpenditureData" : "ExpenditureData";
            const fileType = fileTypeEl ? fileTypeEl.value : "xlsx";
            if (fileType === "csv") {
                let csv = "";
                table.querySelectorAll("tr").forEach(row => {
                    const cells = Array.from(row.querySelectorAll("th, td")).map(c => `"${c.textContent.replace(/"/g,'""')}"`);
                    csv += cells.join(",") + "\n";
                });
                const blob = new Blob([csv], { type: "text/csv" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `${fileName}.csv`;
                a.click();
            } else {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.table_to_sheet(table);
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, `${fileName}.xlsx`);
            }
            const saveAsModal = document.getElementById("saveAsModal");
            if (saveAsModal) saveAsModal.style.display = "none";
            unsavedChanges = false;
        });
    }

    /* ---------------------------
       Final housekeeping
       --------------------------- */
    window.addEventListener("resize", () => { if (expenditureChart) updateChart(); });

    // Mark unsaved changes on any addition/removal event
    const mutationObserver = new MutationObserver(() => { unsavedChanges = true; });
    mutationObserver.observe(tableTbody, { childList: true, subtree: true });

</script>
<script>
    document.getElementById('Home_btn').addEventListener('click', () => {
        // Tell the main process to open Dashboard.html and close this window
        window.electronAPI.openDashboard();
    });
</script>

<!-- Partial for General Expenditure.html ‚Äî updated script section (replace existing <script>...</script>) -->
<script>
    /* ---------------------------
       Utilities & Config (updated)
       --------------------------- */
    const tableTbody = document.querySelector(".table-container table tbody");
    const exportSaveKey = "expenditureData_v1"; // canonical key for Reports
    const formulasKey = "expenditureFormulas_v1";
    let unsavedChanges = false;

    // helper id
    function genId(){ return 'id_' + Math.random().toString(36).slice(2,9); }

    const frequencyMultipliers = { Instance:1, Daily:365, Weekly:52, Monthly:12, Annually:1, "Bi-Annually":2, Quarterly:4, Thrice:3, Twice:2 };

    // color generator (unchanged)
    function colorForClass(name) { if(!name) return "#CCCCCC"; let h=0; for(let i=0;i<name.length;i++) h=(h<<5)-h+name.charCodeAt(i); return `hsl(${Math.abs(h)%360},65%,55%)`; }

    /* ---------------------------
       Persistence: save / load table (structured)
       --------------------------- */
    function saveTableToStorage() {
        const classes = {};
        document.querySelectorAll(".table-container table tbody tr").forEach(tr => {
            const cells = Array.from(tr.cells).map(td => td.textContent.trim());
            if (!cells.length || cells.every(c=>c==="")) return;
            const clsName = cells[1] || "(Unspecified)";
            const itemName = cells[2] || "";
            const details = cells[3] || "";
            const units = Number((cells[4]||"").replace(/[^0-9.\-]/g,""))||0;
            const frequency = cells[5] || "";
            const number = Number((cells[6]||"").replace(/[^0-9.\-]/g,""))||0;
            const charge = Number((cells[7]||"").replace(/[^0-9.\-]/g,""))||0;
            const total = Number((cells[8]||"").replace(/[^0-9.\-]/g,""))|| computeRowTotalFromCells(tr);

            if(!classes[clsName]) classes[clsName] = { id: genId(), name: clsName, items: [] };
            classes[clsName].items.push({
                id: genId(),
                name: itemName || details || 'Item',
                details,
                units,
                frequency,
                number,
                charge,
                total
            });
        });
        const out = Object.keys(classes).map(k => classes[k]);
        try{
            localStorage.setItem(exportSaveKey, JSON.stringify(out));
            unsavedChanges = false;
            // create a backup of raw table html (optional)
            localStorage.setItem("expenditureTableHtml_backup", document.querySelector(".table-container table").outerHTML);
        }catch(err){ console.error('save failed', err); }
    }

    function loadTableFromStorage() {
        const raw = localStorage.getItem(exportSaveKey);
        if(!raw) return false;
        try {
            const groups = JSON.parse(raw);
            if(!Array.isArray(groups) || groups.length===0) return false;
            tableTbody.innerHTML = "";
            groups.forEach(group => {
                const clsName = group.name || "(Unspecified)";
                const items = Array.isArray(group.items) ? group.items : [];
                items.forEach(item => {
                    const tr = tableTbody.insertRow();
                    tr.insertCell(0).textContent = "";
                    tr.insertCell(1).textContent = clsName;
                    tr.insertCell(2).textContent = item.name || "";
                    tr.insertCell(3).textContent = item.details || "";
                    tr.insertCell(4).textContent = (item.units !== undefined) ? String(item.units) : "";
                    tr.insertCell(5).textContent = item.frequency || "";
                    tr.insertCell(6).textContent = (item.number !== undefined) ? String(item.number) : "";
                    tr.insertCell(7).textContent = (item.charge !== undefined) ? Number(item.charge).toFixed(2) : "";
                    tr.insertCell(8).textContent = (item.total !== undefined) ? Number(item.total).toFixed(2) : computeRowTotalFromCells(tr);
                    Array.from(tr.cells).forEach((td, idx) => { td.contentEditable = idx !== 0; td.tabIndex = 0; });
                    tr.onclick = () => selectRow(tr);
                });
            });
            updateRowNumbers(); updateChart(); return true;
        } catch(e){ console.error('load error', e); return false; }
    }

    /* ---------------------------
       Existing functions retained (updateTotalAmountInput, getFrequencyMultiplierFromSelect etc.)
       --------------------------- */

    function getFrequencyMultiplierFromSelect(selectEl) {
        const opt = selectEl.options[selectEl.selectedIndex];
        if (!opt) return 1;
        const dm = opt.getAttribute("data-mult");
        if (dm) return parseFloat(dm) || 1;
        const text = opt.value || opt.text;
        return frequencyMultipliers[text] || 1;
    }

    function updateTotalAmountInput() {
        const units = parseFloat(document.getElementById("units").value) || 0;
        const number = parseFloat(document.getElementById("number").value) || 0;
        const charge = parseFloat(document.getElementById("charge").value) || 0;
        const freqMultiplier = getFrequencyMultiplierFromSelect(document.getElementById("frequency"));
        const total = units * number * charge * freqMultiplier;
        document.getElementById("totalAmount").value = isFinite(total) ? total.toFixed(2) : "0.00";
    }

    ["units","number","charge","frequency"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) { el.addEventListener('input', updateTotalAmountInput); el.addEventListener('change', updateTotalAmountInput); }
    });

    // rest of form submit and logic remains the same, but call saveTableToStorage() at appropriate times
    let selectedRow = null;
    document.getElementById("expenditureForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const cls = document.getElementById("expenditure_class").value.trim();
        const item = document.getElementById("expenditure_item").value.trim();
        const details = document.getElementById("details").value.trim();
        const units = parseFloat(document.getElementById("units").value) || 0;
        const freqSelect = document.getElementById("frequency");
        const freqText = freqSelect.options[freqSelect.selectedIndex]?.value || "";
        const freqMultiplier = getFrequencyMultiplierFromSelect(freqSelect);
        const number = parseFloat(document.getElementById("number").value) || 0;
        const charge = parseFloat(document.getElementById("charge").value) || 0;
        const total = units * number * charge * freqMultiplier;

        const unitsStr = (units || units === 0) ? units.toString() : "";
        const numberStr = (number || number === 0) ? number.toString() : "";
        const chargeStr = isFinite(charge) ? Number(charge).toFixed(2) : "";
        const totalStr = isFinite(total) ? Number(total).toFixed(2) : "0.00";

        if (selectedRow) {
            selectedRow.cells[1].textContent = cls;
            selectedRow.cells[2].textContent = item;
            selectedRow.cells[3].textContent = details;
            selectedRow.cells[4].textContent = unitsStr;
            selectedRow.cells[5].textContent = freqText;
            selectedRow.cells[6].textContent = numberStr;
            selectedRow.cells[7].textContent = chargeStr;
            selectedRow.cells[8].textContent = totalStr;
            selectedRow = null;
        } else {
            const tr = tableTbody.insertRow();
            tr.insertCell(0).textContent = "";
            tr.insertCell(1).textContent = cls;
            tr.insertCell(2).textContent = item;
            tr.insertCell(3).textContent = details;
            tr.insertCell(4).textContent = unitsStr;
            tr.insertCell(5).textContent = freqText;
            tr.insertCell(6).textContent = numberStr;
            tr.insertCell(7).textContent = chargeStr;
            tr.insertCell(8).textContent = totalStr;
            tr.onclick = () => selectRow(tr);
            Array.from(tr.cells).forEach((td, idx) => { td.contentEditable=idx!==0; td.tabIndex=0; });
        }

        document.getElementById("expenditureForm").reset();
        document.getElementById("totalAmount").value = "";
        updateRowNumbers();
        saveTableToStorage();
        updateChart();
        unsavedChanges = false;
        // push a notification to Dashboard (if available)
        if (window.AppNotifications && typeof window.AppNotifications.push === 'function') {
            window.AppNotifications.push('Expenditure saved', `A row was added/updated in General Expenditure.`);
        }
    });

    function selectRow(row) {
        selectedRow = row;
        document.getElementById('expenditure_class').value = row.cells[1].textContent;
        document.getElementById('expenditure_item').value = row.cells[2].textContent;
        document.getElementById('details').value = row.cells[3].textContent;
        document.getElementById('units').value = row.cells[4].textContent;
        const freqVal = row.cells[5].textContent;
        const frequencySelect = document.getElementById("frequency");
        Array.from(frequencySelect.options).forEach(opt => { opt.selected = (opt.value === freqVal); });
        document.getElementById('number').value = row.cells[6].textContent;
        document.getElementById('charge').value = row.cells[7].textContent;
        document.getElementById('totalAmount').value = row.cells[8].textContent;
    }

    document.getElementById("clearBtn").addEventListener("click", () => { document.getElementById("expenditureForm").reset(); selectedRow=null; });

    // import/populate functions remain same but call saveTableToStorage at end already

    // recalc button
    document.getElementById("recalcBtn").addEventListener("click", () => {
        document.querySelectorAll(".table-container table tbody tr").forEach(tr => {
            const newTotal = computeRowTotalFromCells(tr);
            tr.cells[8].textContent = newTotal;
        });
        updateRowNumbers();
        saveTableToStorage();
        updateChart();
    });

    // chart / updateChart etc. (same as before)
    let expenditureChart = null;
    let chartVisibility = {};

    function updateChart(){
        const rows = Array.from(document.querySelectorAll(".table-container table tbody tr")).filter(r => r.style.display !== "none");
        const agg = {};
        rows.forEach(r => {
            const cls = r.cells[1]?.textContent?.trim() || "(Unspecified)";
            const total = parseFloat(r.cells[8]?.textContent) || 0;
            if(!agg[cls]) agg[cls] = 0;
            agg[cls] += total;
        });
        const labels = Object.keys(agg);
        const data = labels.map(l => agg[l]);
        const colors = labels.map(l => colorForClass(l));
        labels.forEach(l => { if(chartVisibility[l]===undefined) chartVisibility[l]=true; });
        const visibleData = data.map((v,i)=> chartVisibility[labels[i]] ? v : 0);
        const ctx = document.getElementById("expenditureChart").getContext("2d");
        if(expenditureChart) expenditureChart.destroy();
        const totalSum = visibleData.reduce((s,v)=>s+v,0) || 1;
        expenditureChart = new Chart(ctx, {
            type:'doughnut',
            data:{ labels, datasets:[{ data:visibleData, backgroundColor:colors, borderColor:'#fff', borderWidth:2 }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:function(context){ const val=context.parsed; const pct=((val/totalSum)*100).toFixed(2); return `${context.label}: $${Number(val).toLocaleString()} (${pct}%)`; } } } } }
        });

        const legend = document.getElementById("chartLegend");
        legend.innerHTML = "";
        labels.forEach((label,i) => {
            const item = document.createElement('div'); item.className='legend-item'; if(!chartVisibility[label]) item.style.opacity='0.45';
            const dot = document.createElement('span'); dot.className='legend-dot'; dot.style.background = colors[i];
            const text = document.createElement('span'); text.textContent = `${label} ‚Äî $${Number(data[i]).toLocaleString()}`;
            item.appendChild(dot); item.appendChild(text);
            item.addEventListener('click', ()=> { chartVisibility[label]=!chartVisibility[label]; item.style.opacity = chartVisibility[label] ? '1' : '0.45'; updateChart(); });
            legend.appendChild(item);
        });
    }

    // sync on manual edits
    tableTbody.addEventListener('input', (ev) => {
        const td = ev.target.closest('td'); if(!td) return;
        const tr = td.parentElement; tr.cells[8].textContent = computeRowTotalFromCells(tr);
        unsavedChanges = true; saveTableToStorage(); updateChart();
    });

    tableTbody.addEventListener('blur', (ev)=> { const td = ev.target.closest('td'); if(!td) return; const tr = td.parentElement; tr.cells[8].textContent = computeRowTotalFromCells(tr); updateRowNumbers(); unsavedChanges = true; saveTableToStorage(); updateChart(); }, true);

    document.addEventListener('DOMContentLoaded', () => { const restored = loadTableFromStorage(); if(!restored) tableTbody.innerHTML=''; updateRowNumbers(); updateChart(); });

    function searchTable(){
        const q = document.getElementById("searchInput").value.toLowerCase().trim();
        const rows = document.querySelectorAll(".table-container table tbody tr");
        rows.forEach(r => { const text = r.innerText.toLowerCase(); r.style.display = text.includes(q) ? "" : "none"; });
        updateRowNumbers(); updateChart();
    }

    // top menu helpers & export
    function toggleDropdown(id){ const dropdown = document.getElementById(id); dropdown.style.display = dropdown.style.display === 'flex' || dropdown.style.display === 'block' ? 'none' : 'block'; }
    document.addEventListener('click', function(ev){ const dd = document.getElementById('coneDropdown'); const toggleBtn = document.getElementById('ToggleBtn'); if(dd && toggleBtn && !dd.contains(ev.target) && !toggleBtn.contains(ev.target)) dd.style.display = 'none'; });

    document.getElementById("Open_btn")?.addEventListener("click", () => {
        // reuse file input flow already implemented
        const input = document.createElement("input"); input.type = "file"; input.accept = ".csv,.xlsx,.xls";
        input.addEventListener("change", (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            if(file.name.toLowerCase().endsWith(".csv")){ reader.onload = ev => { const rows = ev.target.result.split(/\r?\n/).map(r=>r.split(',')); populateTableFromArray(rows); saveTableToStorage(); }; reader.readAsText(file); }
            else { reader.onload = ev=>{ const data = new Uint8Array(ev.target.result); const wb = XLSX.read(data,{type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(ws,{header:1}); populateTableFromArray(rows); saveTableToStorage(); }; reader.readAsArrayBuffer(file); }
        });
        input.click();
    });

    // Print
    document.getElementById("Print_btn")?.addEventListener("click", ()=> { const tableHtml = document.querySelector(".table-container table").outerHTML; const w = window.open("","", "width=1000,height=700"); w.document.write(`<html><head><title>Print</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #000;padding:6px;text-align:left}</style></head><body>${tableHtml}</body></html>`); w.document.close(); w.print(); });

    // context/menu and formulas (kept same)...
    // ... (rest of your existing logic follows intact) ...
    // ensure Home button routing:
    document.getElementById('Home_btn')?.addEventListener('click', ()=> {
        if (window.electronAPI && typeof window.electronAPI.openWindow === 'function') window.electronAPI.openWindow('Dashboard.html');
        else window.location.href = 'Dashboard.html';
    });
</script>

</body>
</html>
